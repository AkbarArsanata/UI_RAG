<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BPS Calendar Events</title>
    <style>
        :root {
            /* Palet Warna Modern & Profesional - Sesuai dengan Chat */
            /* Terang */
            --bg-light: #f1f5f9;
            --surface-light: #ffffff;
            --text-light: #1e293b;
            --muted-light: #64748b;
            --accent-light: #2563eb;
            --header-bg-light: linear-gradient(135deg, var(--accent-light), #1d4ed8);
            --user-bubble-bg-light: #dbeafe;
            --user-bubble-text-light: #1e40af;
            --user-bubble-border-light: color-mix(in srgb, var(--user-bubble-bg-light) 40%, transparent);
            --bot-bubble-bg-light: #f8fafc;
            --bot-bubble-text-light: #1e293b;
            --bot-bubble-border-light: color-mix(in srgb, var(--bot-bubble-bg-light) 40%, transparent);
            --input-bg-light: #ffffff;
            --input-border-light: #cbd5e1;
            --btn-bg-light: var(--accent-light);
            --btn-color-light: #ffffff;
            --btn-hover-light: color-mix(in srgb, var(--btn-bg-light) 90%, black);
            /* Hapus baris lama untuk --fab-bg-light, --fab-color-light, --fab-border-light */

            /* Gelap */
            --bg-dark: #0f172a;
            --surface-dark: #1e293b;
            --text-dark: #e2e8f0;
            --muted-dark: #94a3b8;
            --accent-dark: #3b82f6;
            --header-bg-dark: linear-gradient(135deg, var(--accent-dark), #2563eb);
            --user-bubble-bg-dark: #1e3a8a;
            --user-bubble-text-dark: #dbeafe;
            --user-bubble-border-dark: color-mix(in srgb, var(--user-bubble-bg-dark) 40%, transparent);
            --bot-bubble-bg-dark: #334155;
            --bot-bubble-text-dark: #e2e8f0;
            --bot-bubble-border-dark: color-mix(in srgb, var(--bot-bubble-bg-dark) 40%, transparent);
            --input-bg-dark: #334155;
            --input-border-dark: #475569;
            --btn-bg-dark: var(--accent-dark);
            --btn-color-dark: #0f172a;
            --btn-hover-dark: color-mix(in srgb, var(--btn-bg-dark) 90%, white);
            /* Hapus baris lama untuk --fab-bg-dark, --fab-color-dark, --fab-border-dark */

            /* Variabel Dinamis */
            --bg: var(--bg-light);
            --surface: var(--surface-light);
            --text: var(--text-light);
            --muted: var(--muted-light);
            --accent: var(--accent-light);
            --header-bg: var(--header-bg-light);
            --input-bg: var(--input-bg-light);
            --input-border: var(--input-border-light);
            --btn-bg: var(--btn-bg-light);
            --btn-color: var(--btn-color-light);
            --btn-hover: var(--btn-hover-light);
            /* FAB visual: cukup kontras terhadap surface namun tetap harmonis */
            --fab-bg: color-mix(in srgb, var(--accent) 12%, var(--surface) 88%);
            --fab-color: color-contrast(var(--fab-bg) vs var(--surface), var(--surface), var(--accent));
            --fab-border: color-mix(in srgb, var(--accent) 18%, transparent);
            /* FAB stroke default (light theme) */
            --fab-stroke: rgba(37, 99, 235, 0.95);
            /* Radius & Shadow */
            --radius: 18px;
            --radius-btn: 14px;
            --radius-fab: 50%;
            --card-shadow: 0 4px 12px -2px color-mix(in srgb, var(--bg) 50%, rgba(0, 0, 0, 0.3));
            --input-shadow: 0 1px 3px 0 color-mix(in srgb, var(--bg) 30%, rgba(0, 0, 0, 0.2));
            --btn-shadow: 0 4px 6px -1px color-mix(in srgb, var(--btn-bg) 30%, transparent), 0 2px 4px -1px color-mix(in srgb, var(--btn-bg) 20%, transparent);
            --btn-shadow-hover: 0 6px 8px -1px color-mix(in srgb, var(--btn-bg) 40%, transparent), 0 4px 6px -1px color-mix(in srgb, var(--btn-bg) 30%, transparent);
            --fab-shadow: 0 6px 18px -6px color-mix(in srgb, var(--bg) 55%, rgba(0, 0, 0, 0.45));
            --fab-shadow-hover: 0 10px 28px -10px color-mix(in srgb, var(--bg) 60%, rgba(0, 0, 0, 0.5));
            /* Stroke untuk batas tegas di mode terang/gelap */
            --stroke-light: color-mix(in srgb, var(--input-border-light) 85%, rgba(0, 0, 0, 0.06));
            --stroke-dark: color-mix(in srgb, var(--input-border-dark) 85%, rgba(255, 255, 255, 0.06));
            --stroke: var(--stroke-light);
        }

        body.dark-theme {
            --stroke: var(--stroke-dark);
            --bg: var(--bg-dark);
            --surface: var(--surface-dark);
            --text: var(--text-dark);
            --muted: var(--muted-dark);
            --accent: var(--accent-dark);
            --header-bg: var(--header-bg-dark);
            --input-bg: var(--input-bg-dark);
            --input-border: var(--input-border-dark);
            --btn-bg: var(--btn-bg-dark);
            --btn-color: var(--btn-color-dark);
            --btn-hover: var(--btn-hover-dark);
            --fab-bg: color-mix(in srgb, var(--accent) 16%, var(--surface) 84%);
            --fab-color: color-contrast(var(--fab-bg) vs var(--surface), var(--surface), var(--accent));
            --fab-border: color-mix(in srgb, var(--accent) 22%, transparent);
            /* stroke untuk mode gelap: putih lembut agar kontras */
            --fab-stroke: rgba(255, 255, 255, 0.92);
        }

        /* FAB / Toggle konsisten dengan chat: kontras dan fokus aksesibel */
        .fab {
            background-color: var(--fab-bg);
            color: var(--fab-color);
            border: 1px solid var(--fab-border);
            box-shadow: var(--fab-shadow);
            /* FAB stroke warna sesuai tema: biru terang di light, putih di dark */
            /* FAB stroke warna sesuai tema: biru terang di light, putih di dark */
            --fab-stroke: rgba(37, 99, 235, 0.95);
        }

        /* Terapkan stroke eksternal untuk calendar FAB dan theme toggle */
        #calendar-fab,
        #themeToggle {
            box-shadow: var(--fab-shadow), 0 0 0 2px var(--fab-stroke);
            transition: box-shadow 0.18s ease, transform 0.2s;
        }

        #calendar-fab:hover,
        #themeToggle:hover {
            box-shadow: var(--fab-shadow-hover), 0 0 0 3px var(--fab-stroke);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 24px 20px;
            margin: 0;
        }

        .calendar-container {
            width: 100%;
            max-width: 920px;
            max-height: calc(100vh - 48px);
            margin: 0 auto;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            border: 1px solid var(--stroke);
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            padding: 1.6rem;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
            overflow: auto;
        }

        .calendar-header {
            background: var(--header-bg);
            color: white;
            padding: 1.3rem 1.6rem;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: var(--input-shadow);
            border-bottom: 1px solid var(--stroke);
            border-radius: var(--radius) var(--radius) 0 0;
            overflow: hidden;
        }

        .calendar-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .calendar-title {
            color: white;
            font-size: 1.3rem;
            font-weight: 600;
            letter-spacing: -0.015em;
            margin: 0;
        }

        .calendar-desc {
            text-align: center;
            color: var(--muted);
            font-size: 1.02rem;
            margin: 0.5rem 0 1rem 0;
            font-weight: 500;
            opacity: 0.92;
            padding: 0 1rem;
        }

        .calendar-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            justify-content: center;
            align-items: center;
            padding: 0 0.5rem;
        }

        .calendar-tools input,
        .calendar-tools select {
            padding: 0.7rem 1rem;
            border-radius: var(--radius-btn);
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text);
            font-size: 0.98rem;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            min-width: 150px;
        }

        .calendar-tools select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-right: 2.6rem;
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 14px;
            cursor: pointer;
        }

        .calendar-tools select {
            background-image: url("image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='14' height='8' viewBox='0 0 14 8'><path fill='%23%232563eb' d='M7 8L0 0h14z'/></svg>");
        }

        body.dark-theme .calendar-tools select {
            background-image: url("image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='14' height='8' viewBox='0 0 14 8'><path fill='%23ffffff' d='M7 8L0 0h14z'/></svg>");
        }

        .calendar-tools input:focus,
        .calendar-tools select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 18%, transparent);
        }

        .calendar-btn {
            padding: 0.85rem 1.25rem;
            border-radius: var(--radius-btn);
            font-size: 1rem;
            font-weight: 600;
            border: 1px solid var(--fab-border);
            cursor: pointer;
            background: var(--fab-bg);
            color: var(--fab-color);
            box-shadow: var(--fab-shadow);
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            min-height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-btn:hover,
        .calendar-btn:focus {
            background: color-mix(in srgb, var(--fab-bg) 90%, black);
            transform: translateY(-2px);
            box-shadow: var(--fab-shadow-hover);
        }

        .calendar-btn:active {
            transform: translateY(0);
            box-shadow: var(--fab-shadow);
        }

        #eventCount {
            text-align: center;
            color: var(--accent);
            font-size: 1.08rem;
            font-weight: 600;
            margin: 0.5rem 0;
            opacity: 0.9;
            transition: color 0.3s;
        }

        #calendarResult {
            flex: 1;
            background: var(--input-bg);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-btn);
            padding: 1.2rem;
            font-size: 1rem;
            min-height: 200px;
            max-height: 60vh;
            overflow-y: auto;
            box-shadow: var(--input-shadow);
            margin-top: 0.5rem;
            color: var(--text);
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }

        /* Card event */
        .event-card {
            background: var(--surface);
            border: 1px solid var(--stroke);
            border-left: 4px solid var(--accent);
            border-radius: var(--radius-btn);
            padding: 1rem 1.3rem;
            margin-bottom: 0.9rem;
            box-shadow: var(--input-shadow);
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s, background-color 0.3s, border-color 0.3s;
        }

        .event-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px -2px color-mix(in srgb, var(--bg) 60%, rgba(0, 0, 0, 0.4));
        }

        .event-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.3rem;
            transition: color 0.3s;
        }

        .event-date {
            font-size: 0.95rem;
            color: var(--muted);
            margin-bottom: 0.6rem;
            transition: color 0.3s;
        }

        .event-location {
            font-size: 0.9rem;
            color: var(--muted);
            margin-bottom: 0.4rem;
            font-style: italic;
        }

        .event-description {
            font-size: 0.95rem;
            color: var(--text);
            margin-bottom: 0.6rem;
            line-height: 1.5;
        }

        .event-link {
            color: var(--accent);
            font-weight: 500;
            text-decoration: underline;
            transition: color 0.3s;
        }

        .event-link:hover {
            color: color-mix(in srgb, var(--accent) 80%, black);
        }

        /* Single combined badge for time_status + status */
        .event-badge {
            display: inline-block;
            padding: 0.18rem 0.6rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 0.4rem;
            color: var(--accent);
            background-color: color-mix(in srgb, var(--accent) 10%, transparent);
        }

        .event-badge.current {
            background-color: color-mix(in srgb, #f59e0b 12%, transparent);
            color: #f59e0b;
            border: 1px solid color-mix(in srgb, #f59e0b 18%, transparent);
        }

        .event-badge.past {
            background-color: color-mix(in srgb, #ef4444 12%, transparent);
            color: #ef4444;
            border: 1px solid color-mix(in srgb, #ef4444 18%, transparent);
        }

        .event-badge.upcoming {
            background-color: color-mix(in srgb, #10b981 12%, transparent);
            color: #10b981;
            border: 1px solid color-mix(in srgb, #10b981 18%, transparent);
        }

        .event-attendees {
            margin-top: 0.6rem;
            font-size: 0.85rem;
            color: var(--muted);
        }

        .event-attendees-list {
            margin-top: 0.3rem;
            list-style: none;
            padding-left: 0;
        }

        .event-attendees-list li {
            padding: 0.2rem 0;
        }

        .event-labels {
            margin-top: 0.4rem;
            font-size: 0.8rem;
        }

        .event-label {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            margin: 0 0.2rem 0.2rem 0;
            border-radius: 6px;
            background-color: color-mix(in srgb, var(--accent) 10%, transparent);
            color: var(--accent);
            font-weight: 500;
        }

        .event-details {
            margin-top: 0.8rem;
            font-size: 0.85rem;
            color: var(--muted);
            padding-top: 0.5rem;
            border-top: 1px dashed var(--stroke);
        }

        .event-details div {
            margin-bottom: 0.3rem;
        }

        /* Highlight pencarian */
        mark {
            background: color-mix(in srgb, var(--accent) 20%, transparent);
            color: var(--text);
            padding: 0 2px;
            border-radius: 4px;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: color-mix(in srgb, var(--bg) 50%, rgba(0, 0, 0, 0.5));
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            padding: 2rem 2rem 1.5rem 2rem;
            min-width: 320px;
            max-width: 500px;
            position: relative;
            border: 1px solid var(--stroke);
        }

        #loadingModal .modal-content {
            min-width: 220px;
            max-width: 320px;
            padding: 2rem 1.5rem;
            font-size: 1.1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .modal-close {
            position: absolute;
            top: 0.8rem;
            right: 0.8rem;
            background: color-mix(in srgb, var(--text) 20%, transparent);
            color: var(--text);
            border: none;
            border-radius: 50%;
            width: 2.2rem;
            height: 2.2rem;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.18s;
        }

        .modal-close:hover {
            background: color-mix(in srgb, var(--text) 30%, transparent);
        }

        .modal-body {
            margin-top: 0.5rem;
            color: var(--text);
            font-size: 1.08rem;
            line-height: 1.6;
            transition: color 0.3s;
        }

        .modal-body .event-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 0.6rem;
            transition: color 0.3s;
        }

        .modal-body .event-date {
            color: var(--muted);
            font-weight: 500;
            margin-bottom: 0.7rem;
            transition: color 0.3s;
        }

        .modal-body .event-link {
            display: inline-block;
            margin-top: 0.8rem;
            background: var(--btn-bg);
            color: var(--btn-color);
            padding: 0.6rem 1.2rem;
            border-radius: var(--radius-btn);
            text-decoration: none;
            font-weight: 600;
            transition: background 0.18s;
        }

        .modal-body .event-link:hover {
            background: var(--btn-hover);
        }

        /* FAB Modern Minimalis - Sama seperti di Chat */
        .fab {
            position: fixed;
            z-index: 100;
            border-radius: var(--radius-fab);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s, border-color 0.2s;
            box-shadow: var(--fab-shadow);
            text-decoration: none;
            background-color: var(--fab-bg);
            color: var(--fab-color);
            border: 1px solid var(--fab-border);
        }

        .fab:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: var(--fab-shadow-hover);
            background-color: color-mix(in srgb, var(--fab-bg) 90%, var(--text));
        }

        #calendar-fab {
            left: 24px;
            top: 24px;
        }

        #themeToggle {
            right: 24px;
            top: 24px;
        }

        /* optional: prevent collision on very small screens */
        @media (max-width: 420px) {
            #calendar-fab {
                left: 16px;
                top: 18px;
            }

            #themeToggle {
                right: 16px;
                top: 18px;
            }

            /* or move themeToggle slightly down: top: 78px; if still colliding */
        }

        /* Responsive */
        @media (max-width: 700px) {
            body {
                padding: 12px;
            }

            .calendar-container {
                min-height: 95vh;
                padding: 1.2rem;
                padding-top: 1.2rem;
                gap: 1rem;
            }

            .calendar-header {
                position: sticky;
                top: 0;
                z-index: 5;
            }

            .calendar-header {
                padding: 1.1rem;
                gap: 10px;
            }

            .calendar-title {
                font-size: 1.15rem;
            }

            .calendar-icon {
                width: 46px;
                height: 46px;
            }

            .calendar-desc {
                font-size: 0.98rem;
                margin: 0.4rem 0 0.8rem 0;
            }

            .calendar-tools {
                flex-direction: column;
                align-items: stretch;
                gap: 0.6rem;
            }

            .calendar-tools input,
            .calendar-tools select {
                min-width: auto;
                width: 100%;
            }

            .calendar-btn {
                width: 100%;
                padding: 0.8rem 1rem;
            }

            #calendarResult {
                padding: 1rem;
                font-size: 0.95rem;
            }

            .fab {
                width: 46px;
                height: 46px;
                left: 14px;
                top: 14px;
                right: auto;
                bottom: auto;
            }

            #themeToggle {
                width: 46px;
                height: 46px;
                right: 14px;
                top: 14px;
                left: auto;
                bottom: auto;
            }
        }
    </style>
</head>

<body>

    <a href="chat.html" id="calendar-fab" class="fab" title="Chat">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="5" width="18" height="16" rx="4" stroke="currentColor" stroke-width="2" />
            <rect x="7" y="9" width="10" height="2" rx="1" fill="currentColor" />
        </svg>
    </a>
    <button id="themeToggle" class="fab" title="Ganti Tema">🌙</button>

    <div class="calendar-container">
        <div class="calendar-header">
            <span class="calendar-icon" aria-hidden="true">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <rect x="3" y="5" width="18" height="16" rx="4" stroke="currentColor" stroke-width="2" />
                    <rect x="7" y="9" width="10" height="2" rx="1" fill="currentColor" />
                </svg>
            </span>
            <span class="calendar-title">Kalender BPS</span>
        </div>
        <div class="calendar-desc">
            Lihat dan kelola event kalender BPS secara interaktif.
        </div>
        <div id="eventCount" class="calendar-count"></div>

        <!-- Tools -->
        <div class="calendar-tools">
            <input type="text" id="searchEvent" placeholder="🔍 Cari event..." />

            <input type="date" id="startDate" />
            <input type="date" id="endDate" />

            <select id="timeFilter">
                <option value="">Filter Waktu: Semua</option>
                <option value="current">Sedang Berlangsung</option>
                <option value="past">Terlewat</option>
                <option value="upcoming">Akan Datang</option>
            </select>

            <select id="sortEvents">
                <option value="asc">Urutkan: Ascending</option>
                <option value="desc">Urutkan: Descending</option>
            </select>

            <button id="btnGetEvents" class="btn calendar-btn load-btn">
                📅 Muat Event
            </button>
            <button id="btnClearFilter" class="btn calendar-btn clear-btn">
                ❌ Reset Filter
            </button>
        </div>

        <!-- Tempat render event -->
        <div id="calendarResult" class="calendar-result"></div>

        <!-- Modal Loading -->
        <div id="loadingModal" class="modal-overlay" style="display:none;">
            <div class="modal-content" style="text-align:center;">
                <div style="font-size:2.2rem; margin-bottom:1rem;">⏳</div>
                <div style="font-weight:600; color:var(--accent);">Memuat data kalender...</div>
            </div>
        </div>
    </div>

    <script>
        // --- Theme Toggle Logic (sama dengan chat.html) ---
        const themeToggle = document.getElementById('themeToggle');
        const applyTheme = (isDark) => {
            document.body.classList.toggle('dark-theme', isDark);
            themeToggle.textContent = isDark ? '☀️' : '🌙';
            localStorage.setItem('darkMode', isDark ? 'dark' : 'light');
        };

        const savedTheme = localStorage.getItem('darkMode');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const initialTheme = savedTheme ? savedTheme === 'dark' : prefersDark;
        applyTheme(initialTheme);

        themeToggle.addEventListener('click', () => {
            applyTheme(!document.body.classList.contains('dark-theme'));
        });

        // Ambil elemen
        const calendarResult = document.getElementById('calendarResult');
        const eventCount = document.getElementById('eventCount');

        // Fungsi untuk mengambil event dari API
        async function fetchEvents() {
            const modal = document.getElementById('loadingModal');
            modal.style.display = 'flex';

            try {
                const search = document.getElementById('searchEvent').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const timeFilter = document.getElementById('timeFilter').value;
                const sortValue = document.getElementById('sortEvents').value;

                const requestBody = {
                    search: search || undefined,
                    start_date: startDate || undefined,
                    end_date: endDate || undefined,
                    sort_order: sortValue,
                    time_filter: timeFilter || undefined
                };

                Object.keys(requestBody).forEach(key => {
                    if (requestBody[key] === undefined) {
                        delete requestBody[key];
                    }
                });

                const response = await fetch(' https://gcal-bps-service-763926970161.asia-southeast1.run.app/get_events', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log("Response status:", response.status);
                console.log("Request Body:", JSON.stringify(requestBody));

                if (!response.ok) {
                    let errorText = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorText = errorData.detail || errorText;
                    } catch (e) {
                        try {
                            errorText = await response.text();
                        } catch (e2) {
                            // Jika tidak bisa dibaca, gunakan pesan default
                        }
                    }
                    throw new Error(errorText);
                }

                const contentType = response.headers.get("content-type");
                console.log("Content-Type:", contentType);

                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error("Respons bukan JSON yang valid. Content-Type: " + contentType);
                }

                const events = await response.json();
                console.log("Data events diterima:", events);

                displayEvents(events);

            } catch (error) {
                console.error("Gagal mengambil event:", error);
                calendarResult.innerHTML = `<p style="color: red;">Gagal memuat event: ${error.message}</p>`;
            } finally {
                modal.style.display = 'none';
            }
        }

        // Fungsi untuk menampilkan event di halaman (dengan informasi lengkap)
        function displayEvents(events) {
            if (!events || events.length === 0) {
                calendarResult.innerHTML = '<p>Tidak ada event ditemukan.</p>';
                eventCount.textContent = '0 Event Ditemukan';
                return;
            }

            let html = '';
            events.forEach(event => {
                const start = new Date(event.start).toLocaleString();
                const end = new Date(event.end).toLocaleString();

                // Format deskripsi
                const description = event.description ? event.description.replace(/\n/g, '<br>') : 'Tidak ada deskripsi.';

                // Format lokasi
                const location = event.location ? `<div class="event-location">📍 ${event.location}</div>` : '';

                // Gabungkan time_status + status menjadi satu badge (tulisannya menyatu)
                const badges = [];
                if (event.time_status) badges.push(event.time_status);
                if (event.status) badges.push(event.status);
                const badgeText = badges.length ? badges.join(' • ') : '';

                // Map berbagai kemungkinan label/time_status -> kelas CSS tunggal yang konsisten
                const mapStatusToClass = (label) => {
                    if (!label) return '';
                    const s = String(label).toLowerCase();
                    if (s.includes('current') || s.includes('sedang')) return 'current';
                    if (s.includes('past') || s.includes('terlewat')) return 'past';
                    if (s.includes('upcoming') || s.includes('akan')) return 'upcoming';
                    // fallback: buat token aman tanpa spasi/karakter non-alfa
                    return s.replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '');
                };
                const timeStatusClass = mapStatusToClass(event.time_status);
                const badgeHTML = badgeText ? `<div class="event-badge ${timeStatusClass}">${badgeText}</div>` : '';

                // Format attendees
                let attendeesHTML = '';
                if (event.attendees && event.attendees.length > 0) {
                    const attendeeList = event.attendees.map(att => `<li>${att.displayName || att.email}</li>`).join('');
                    attendeesHTML = `
                        <div class="event-attendees">👥 Peserta:</div>
                        <ul class="event-attendees-list">${attendeeList}</ul>
                    `;
                }

                // Format labels (tetap tampilkan label event di card, tapi tidak ada filter)
                let labelsHTML = '';
                if (event.labels && event.labels.length > 0) {
                    const labelList = event.labels.map(label => `<span class="event-label">${label}</span>`).join('');
                    labelsHTML = `<div class="event-labels">${labelList}</div>`;
                }

                // Format details tambahan
                let detailsHTML = '';
                if (event.creator || event.organizer || event.reminders) {
                    detailsHTML = `<div class="event-details">`;
                    if (event.creator) {
                        detailsHTML += `<div><strong>Creator:</strong> ${event.creator.displayName || event.creator.email}</div>`;
                    }
                    if (event.organizer) {
                        detailsHTML += `<div><strong>Organizer:</strong> ${event.organizer.displayName || event.organizer.email}</div>`;
                    }
                    if (event.reminders && event.reminders.length > 0) {
                        const reminderList = event.reminders.map(r => `${r.method} ${r.minutes} menit`).join(', ');
                        detailsHTML += `<div><strong>Reminders:</strong> ${reminderList}</div>`;
                    }
                    detailsHTML += `</div>`;
                }

                html += `
                    <div class="event-card">
                        <div class="event-title">${event.summary}</div>
                        <div class="event-date">📅 ${start} - ${end}</div>
                        ${location}
                        <div class="event-description">${description}</div>
                        ${badgeHTML}
                        ${labelsHTML}
                        ${attendeesHTML}
                        ${detailsHTML}
                        ${event.link ? `<a href="${event.link}" target="_blank" class="event-link">Lihat di Google Calendar</a>` : ''}
                    </div>
                `;
            });

            calendarResult.innerHTML = html;
            eventCount.textContent = `${events.length} Event Ditemukan`;
        }

        // Event listener untuk tombol Ambil Events
        document.getElementById('btnGetEvents').addEventListener('click', fetchEvents);

        // Event listener untuk Reset Filter
        document.getElementById('btnClearFilter').addEventListener('click', function () {
            document.getElementById('searchEvent').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('timeFilter').value = '';
            document.getElementById('sortEvents').value = 'asc';
            calendarResult.innerHTML = '<p>Filter telah direset. Silakan klik "Ambil Events" untuk menampilkan ulang.</p>';
            eventCount.textContent = '';
        });

        // Panggil fetchEvents saat halaman dimuat pertama kali (opsional)
        // fetchEvents();
    </script>

</body>

</html>